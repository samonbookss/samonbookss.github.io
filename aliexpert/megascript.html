<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parser</title>
  <script>
    const parsedJsonDocumentExample = {
      "titleModule": {
          "subject": "USB güvenli şarj ile taşınabilir GÜNEŞ PANELI 5V 2W güneş plaka Stabilize pil şarj cihazı güç banka telefon açık kamp için ev",
          "feedbackRating": {},
          "storeModule": {}
      },
      "storeModule": {
          "topRatedSeller": false,
          "storeURL": "//tr.aliexpress.com/store/1103187308",
          "storeName": "3c Consumer Electronics Accessories Store",
          "openedYear": "Eyl 25, 2023"
      },
      "commonModule": {
          "description": "USB güvenli şarj ile taşınabilir GÜNEŞ PANELI 5V 2W güneş plaka Stabilize pil şarj cihazı güç banka telefon açık kamp için ev\nGÜNEŞ PANELI, dayanıklı ve uzun bir servis ömrüne sahip olan yüksek kaliteli alüminyum alaşımlı malzeme 'den yapılmıştır.\n✓ Ücretsiz Kargo Worldwide tadını çıkarın! ✓ Sınırlı Zaman Satış ✓ Kolay Dönüş",
          "keywords": "Taşınabilir GÜNEŞ PANELI,Pil şarj cihazı,2W 5V GÜNEŞ PANELI şarj cihazı,Güneş panelleri"
      },
      "imageModule": {
          "imagePathList": []
      },
      "crossLinkModule": {
          "crossLinkGroupList": []
      },
      "actionModule": {
          "categoryId": 52806,
          "comingSoon": false,
          "companyId": 2675928024,
          "rootCategoryId": 44,
          "itemWishedCount": 10600,
          "storeNum": 1103187308,
          "preSale": false
      },
      "priceModule": {
          "bigSellProduct": false,
          "discountPromotion": true,
          "discount": 10
      },
      "quantityModule": {
          "totalAvailQuantity": 687
      },
      "recommendModule": {
          "platformCount": 1027
      },
      "shippingModule": {
          "hbaFreeShipping": false
      },
      "sd_productPrices": 48.41,
      "sd_priceCurrency": "EUR",
      "sd_productPriceNew": 5.71
    };

    function getProductId(theUrl) {
        const productIdMatch = theUrl.match(/\/item\/(.*?)\.html/);
    
        if (productIdMatch && productIdMatch[1]) {
        const productId = productIdMatch[1];
            return productId;
        }
        return undefined;
    }
  
    function manualParseAer(textWithJson, parsed, productId) {
      function search(obj, path, expectedType) {
        if (typeof obj === 'object' && obj !== null && !Array.isArray(obj)) {
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    const value = obj[key];
                    if (key === path[0]) {
                        if (path.length === 1 && value !== null) {
                            switch (expectedType) {
                                case 'number':
                                    if (typeof value === 'number') {
                                        return value;
                                    }
                                    break;
                                case 'string':
                                    if (typeof value === 'string') {
                                        return value;
                                    }
                                    break;
                                case 'numberOrString':
                                    if (typeof value === 'number' || typeof value === 'string') {
                                        return value;
                                    }
                                    break;
                            }
                        } else if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                            const result = search(value, path.slice(1), expectedType);
                            if (result !== null) {
                                return result;
                            }
                        }
                    } else if (Array.isArray(value)) {
                        for (const item of value) {
                            const result = search(item, path, expectedType);
                            if (result !== null) {
                                return result;
                            }
                        }
                    } else {
                        const result = search(value, path, expectedType);
                        if (result !== null) {
                            return result;
                        }
                    }
                }
            }
        }
        return null;
      }
    
      function handleApplicationJsonData(data) {
        const paths = [
            { key: "price", path: ["price", "minActivityAmount", "value"], expectedType: "number" },
            { key: "activity_price", path: ["price", "formattedActivityPrice"], expectedType: "string" },
            { key: "discount", path: ["price", "formattedDiscount"], expectedType: "string" },
            { key: "currency", path: ["price", "maxAmount", "currency"], expectedType: "string" },
            { key: "rating", path: ["rating", "middle"], expectedType: "numberOrString" },
            { key: "trade_count", path: ["tradeInfo", "tradeCount"], expectedType: "string" },
            { key: "reviews", path: ["reviews"], expectedType: "string" },
            { key: "trade_count_formatted", path: ["tradeInfo", "formatTradeCount"], expectedType: "string" },
            { key: "subscribers_count", path: ["subscribersCount"], expectedType: "string" },
            { key: "positive_reviews_percentage", path: ["positiveReviews", "percentages"], expectedType: "number" }
        ];
    
        paths.forEach(path => {
            const value = search(data, path.path, path.expectedType);
            if (value !== null) {
                switch (path.key) {
                    case "price":
                        if (typeof value === 'number') {
                            parsed.sd_productPriceNew = value;
                            parsed.sd_productPrices = value;
                        }
                        break;
                    case "currency":
                        if (typeof value === 'string') {
                          parsed.sd_priceCurrency = value;
                        }
                        break;
                    case "rating":
                        if (typeof value === 'number') {
                            parsed.titleModule.feedbackRating.averageStar = value;
                        } else if (typeof value === 'string') {
                            const ratingFloat = parseFloat(value);
                            if (!isNaN(ratingFloat)) {
                                parsed.titleModule.feedbackRating.averageStar = ratingFloat;
                            }
                        }
                        break;
                    case "trade_count":
                        if (typeof value === 'string') {
                            parsed.titleModule.tradeCount = value;
                            parsed.titleModule.feedbackRating.tradeCount = value;
                        }
                        break;
                    case "reviews":
                        if (typeof value === 'string') {
                            const reviewCount = parseInt(value, 10);
                            if (!isNaN(reviewCount)) {
                                parsed.titleModule.feedbackRating.totalValidNum = reviewCount;
                            }
                        }
                        break;
                    case "positive_reviews_percentage":
                        if (typeof value === 'number') {
                            parsed.storeModule.positiveRate = value;
                        } else if (typeof value === 'string') {
                            const positiveRateFloat = parseFloat(value);
                            if (!isNaN(positiveRateFloat)) {
                                parsed.storeModule.positiveRate = positiveRateFloat;
                            }
                        }
                        break;
                }
            }
        });
      }
    
      function extractAppJsonData(htmlString) {
        const scriptTagRegex = /<script id="__AER_DATA__" type="application\/json">([\s\S]*?)<\/script>/g;
    
        // Extract the script tags
        let match;
        let found = false;
        while ((match = scriptTagRegex.exec(htmlString)) !== null) {
          found = true;
          const scriptContent = match[1];
          try {
            const data = JSON.parse(scriptContent);
            handleApplicationJsonData(data);
          } catch (error) {
            console.error('Failed to parse __AER_DATA__ JSON', error);
          }
        }
        return found;
      }
    
      const found = extractAppJsonData(textWithJson);
      if (!found) return null;

      parsed.parsedDataReceived = true;
      return parsed;
    }
  
    window.addEventListener('message', (event) => {
      console.log("Message received");
      console.log(event.origin);
      console.log(event.data);

      try {
        const { pageText, extensionId, windowLocationHref } = event.data;  
        if (extensionId !== '88005553535') return;

        const productId = getProductId(windowLocationHref);
        if (!productId) return;

        // Ваш код парсинга
        const parsedResult = parseHTML(pageText);
        if (!parsedResult) return;

        console.log(parsedResult);
  
        // Отправляем результат обратно в content script
        event.source.postMessage({ parsedResult: parsedResult, productId: productId }, event.origin);

      } catch (error) {
        console.log("Error message other structure");
      }
    });

    function parseHTML(html) {
      const parsed = JSON.parse(JSON.stringify(parsedJsonDocumentExample));
      parsed.sd_priceTodayDate = new Date().toISOString().split("T")[0];
      parsed.sd_priceCurrency = undefined;
      const result = manualParseAer(html, parsed, 42);
      
      return result; // Пример результата
    }
  </script>
</head>
<body>
</body>
</html>
